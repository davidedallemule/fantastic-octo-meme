<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Riconoscimento Colore e Suono</title>
    <style>
        body {
            background-color: #333; /* Colore di sfondo grigio scuro */
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;
            text-align: center;
        }

        #videoElement {
            width: 300px;
            height: 300px;
            border-radius: 50%; /* Crea un cerchio */
            object-fit: cover; /* Assicura che il video riempia il cerchio senza distorsioni */
            border: 5px solid #fff; /* Aggiungi un bordo bianco attorno al cerchio */
        }

        #message {
            color: white;
            margin-top: 20px;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <!-- Video della fotocamera -->
    <video id="videoElement" autoplay></video>

    <!-- Messaggio che mostra il colore riconosciuto -->
    <div id="message">Nessun colore riconosciuto</div>

    <script>
        // Funzione per avviare la fotocamera
        async function startCamera() {
            const videoElement = document.getElementById('videoElement');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                videoElement.srcObject = stream;
            } catch (err) {
                console.log('Errore nell\'accesso alla fotocamera: ', err);
            }
        }

        // Avvia la fotocamera quando la pagina Ã¨ pronta
        window.onload = startCamera;

        // Funzione per analizzare i pixel centrali
        function getColorFromCamera() {
            const video = document.getElementById('videoElement');
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            const width = video.videoWidth;
            const height = video.videoHeight;

            canvas.width = width;
            canvas.height = height;
            context.drawImage(video, 0, 0, width, height);

            // Analisi dei pixel (zona centrale)
            const imageData = context.getImageData(width / 2 - 10, height / 2 - 10, 20, 20);  // Cambiato per ridurre la zona da analizzare
            const pixels = imageData.data;

            let r = 0, g = 0, b = 0;
            for (let i = 0; i < pixels.length; i += 4) {
                r += pixels[i];
                g += pixels[i + 1];
                b += pixels[i + 2];
            }

            const pixelCount = pixels.length / 4;
            r = Math.floor(r / pixelCount);
            g = Math.floor(g / pixelCount);
            b = Math.floor(b / pixelCount);

            // Convertiamo il risultato in formato esadecimale
            return rgbToHex(r, g, b);
        }

        // Funzione per convertire RGB in esadecimale
        function rgbToHex(r, g, b) {
            return '#' + ((1 << 24) | (r << 16) | (g << 8) | b).toString(16).slice(1).toUpperCase();
        }

        // Funzione per determinare la nota in base al colore
        function getNoteFromColor(hex) {
            switch (hex) {
                case '#000000': return { note: 'DO', frequency: 261.63 }; // DO
                case '#00FFFF': return { note: 'RE', frequency: 293.66 }; // RE (azzurro)
                case '#008000': return { note: 'MI', frequency: 329.63 }; // MI (verde)
                case '#FFFF00': return { note: 'FA', frequency: 349.23 }; // FA (giallo)
                case '#FFA500': return { note: 'SOL', frequency: 392.00 }; // SOL (arancione)
                case '#FF0000': return { note: 'LA', frequency: 440.00 }; // LA (rosso)
                case '#800080': return { note: 'SI', frequency: 493.88 }; // SI (viola)
                default: return null;
            }
        }

        // Funzione per emettere il suono in base alla frequenza
        let audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let oscillator;
        let isPlaying = false;

        function playNote(frequenza) {
            if (isPlaying) {
                oscillator.stop();
            }
            oscillator = audioContext.createOscillator();
            oscillator.type = 'sine'; // Tipo dell'oscillatore, onda sinusoidale
            oscillator.frequency.setValueAtTime(frequenza, audioContext.currentTime);
            oscillator.connect(audioContext.destination);
            oscillator.start();
            isPlaying = true;
        }

        function stopNote() {
            if (isPlaying) {
                oscillator.stop();
                isPlaying = false;
            }
        }

        // Funzione per rilevare e agire sui colori
        function detectColorAndPlay() {
            const color = getColorFromCamera();
            const noteData = getNoteFromColor(color);

            const messageElement = document.getElementById('message');
            if (noteData) {
                messageElement.innerHTML = `Colore Riconosciuto: ${noteData.note}`;
                playNote(noteData.frequency);
            } else {
                messageElement.innerHTML = 'Nessun colore riconosciuto';
                stopNote();
            }
        }

        // Verifica continuamente il colore
        setInterval(detectColorAndPlay, 500); // Ogni 500ms verifica il colore
    </script>
</body>
</html>

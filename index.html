<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Color Note WebApp</title>
  <style>
    body {
      margin: 0;
      background-color: #2c2c2c;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
      font-family: sans-serif;
      color: white;
    }
    #videoWrapper {
      border-radius: 50%;
      overflow: hidden;
      width: 80vmin;
      height: 80vmin;
      position: relative;
    }
    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #status {
      position: absolute;
      bottom: 10px;
      width: 100%;
      text-align: center;
      font-size: 1.2em;
      color: white;
      text-shadow: 0 0 4px black;
    }
    canvas {
      display: none;
    }
  </style>
</head>
<body>
  <div id="videoWrapper">
    <video id="video" autoplay playsinline></video>
    <div id="status">Avvio...</div>
  </div>
  <canvas id="canvas"></canvas>

  <script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const statusText = document.getElementById("status");

    let currentNote = null;
    let oscillator = null;
    let audioCtx = null;

    const colorMap = [
      { name: "DO", rgb: [0, 0, 0], note: "C4" },         // Nero
      { name: "RE", rgb: [135, 206, 235], note: "D4" },   // Azzurro
      { name: "MI", rgb: [0, 128, 0], note: "E4" },       // Verde
      { name: "FA", rgb: [255, 255, 0], note: "F4" },     // Giallo
      { name: "SOL", rgb: [255, 165, 0], note: "G4" },    // Arancione
      { name: "LA", rgb: [255, 0, 0], note: "A4" },       // Rosso
      { name: "SI", rgb: [128, 0, 128], note: "B4" }      // Viola
    ];

    const noteFrequencies = {
      "C4": 261.63,
      "D4": 293.66,
      "E4": 329.63,
      "F4": 349.23,
      "G4": 392.00,
      "A4": 440.00,
      "B4": 493.88
    };

    function getColorDistance(c1, c2) {
      return Math.sqrt(
        Math.pow(c1[0] - c2[0], 2) +
        Math.pow(c1[1] - c2[1], 2) +
        Math.pow(c1[2] - c2[2], 2)
      );
    }

    function getClosestColor(rgb) {
      let minDist = Infinity;
      let match = null;
      for (let color of colorMap) {
        const dist = getColorDistance(rgb, color.rgb);
        if (dist < 100) { // Tolleranza aumentata
          if (dist < minDist) {
            minDist = dist;
            match = color;
          }
        }
      }
      return match;
    }

    function getBrightness(rgb) {
      return (rgb[0] + rgb[1] + rgb[2]) / 3;
    }

    function playNote(note, brightness) {
      if (audioCtx == null) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }

      const baseFreq = noteFrequencies[note];
      const brightnessFactor = (brightness - 50) / 200; // regola acuti/gravi
      const frequency = baseFreq + brightnessFactor * 200;

      oscillator = audioCtx.createOscillator();
      oscillator.type = "sine";
      oscillator.frequency.setValueAtTime(frequency, audioCtx.currentTime);
      oscillator.connect(audioCtx.destination);
      oscillator.start();
    }

    function stopNote() {
      if (oscillator) {
        oscillator.stop();
        oscillator.disconnect();
        oscillator = null;
      }
    }

    async function startVideo() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: "environment" } },
          audio: false
        });
        video.srcObject = stream;
        video.onloadedmetadata = () => {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          analyzeFrame();
        };
      } catch (err) {
        statusText.textContent = "Errore accesso fotocamera";
        console.error(err);
      }
    }

    function analyzeFrame() {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const frame = ctx.getImageData(canvas.width / 2, canvas.height / 2, 1, 1);
        const [r, g, b] = frame.data;
        const color = getClosestColor([r, g, b]);
        const brightness = getBrightness([r, g, b]);

        if (color && color.note !== currentNote) {
          stopNote();
          playNote(color.note, brightness);
          currentNote = color.note;
          statusText.textContent = `Nota: ${color.name}`;
        } else if (!color) {
          stopNote();
          currentNote = null;
          statusText.textContent = `Nessun colore riconosciuto`;
        }
      }
      setTimeout(analyzeFrame, 100); // scansione ogni 100ms
    }

    startVideo();
  </script>
</body>
</html>
